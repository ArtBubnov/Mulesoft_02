name: deploy project to dev env

#this scenario can be triggered only by pr_run_munits_orchestration scenario
on:
  workflow_call:

jobs:
  dev:
    runs-on: ubuntu-latest
    #in the env section below variables for mulesoft project pom file for the following sections should be defined:  
    #1. build --> plugin (org.mule.tools.maven) --> cloudHubDeployment  
    #2. build --> plugin (org.mule.tools.maven) --> cloudHubDeployment --> properties 
    env:
    #POM <cloudHubDeployment>
      PLATFORM_USERNAME: artemBubnov
      PLATFORM_PASSWORD: mg5uGwRQ7XM2MeEb
      TOKEN: eyJhbGciOiJFUzI1NiIsInR5cCI6Imp3dCIsImtpZCI6ImFueXBvaW50X2lhbV9wcm9kLWV1LWMyYy04OC0xNjg0MTA4ODE3NTU2IiwidmVyIjoiMS4wIn0.eyJhdXQiOiJTRVJWSUNFIiwiY3R4Ijoic2ZkYy5naWQtYXV0aCIsImlzdCI6Miwic3R5IjoiVGVuYW50Iiwic2NvcGUiOiJ2ZXJpZnkiLCJ2YWFzX2FyZ3MiOnsiYWN0aW9uX2lkIjoibG9naW4iLCJhY3Rpb25fbmFtZSI6IkxvZ2luIiwidHJ1c3RfdmVyaWZpZWRfZGV2aWNlcyI6ZmFsc2UsImVtYWlsIjoiYXJ0ZW0uYnVibm92QHZycGNvbnN1bHRpbmcuY29tIiwicmVkaXJlY3RfdXJpIjoiaHR0cHM6Ly9ldTEuYW55cG9pbnQubXVsZXNvZnQuY29tL2FjY291bnRzL2xvZ2luL21mYV9jYWxsYmFjayIsInN0YXRlIjoiZGU2YWY1ODUtMzI2NS00OGI2LWE4MTctMjI5NzQ4MGJkNzJiIiwidXNlcl9hY2NvdW50X2lkIjoiYTliMzRmM2MtZDgzYy00MTVhLWE1NzgtODZhMWY5ZmUxMTY0IiwidXNlcl9kaXNwbGF5X25hbWUiOiJhcnRlbUJ1Ym5vdiJ9LCJpYXQiOjE2ODY3NDc4ODcsIm5iZiI6MTY4Njc0Nzg4NywiZXhwIjoxNjg2NzQ3OTA3LCJhdWQiOiJ2YWFzIiwiaXNzIjoiYW55cG9pbnRfYWNjZXNzX21hbmFnZW1lbnRfZXUxIiwianRpIjoiOGY1NTMzNjItNzdlNy00ODgwLWIwMmEtMTU5ZTkzY2MyZGYzIn0.GM-IryPN2OSMK0jo1BbxNLMouM6YfCWyp1TO3DevH652iD1drkvCSNUcdg5q3TKuMVr5Ln-3ZouYb1wJAYjiRA
      BUSINESSGROUPID: 5fcc384e-c766-4597-9669-5a9d3f1fbba3
      ENV: Sandbox
      WORKERS: 1
      WORKERS_TYPE: Micro
      REGION: eu-central-1
      URI: https://eu1.anypoint.mulesoft.com
    steps:
      #This action checks-out your repository under $GITHUB_WORKSPACE
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: logger
        run: |
          echo "branches has been mertged"
          echo 'the following is targer branch: '$GITHUB_REF_NAME

      #This step performs:
      # 1. add new dependencies in cache
      # 2. retrieve existing data from cache 
      - name: Checking Cache
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven- 

      #This step deploys data to DEV Mulesoft env
      - name: Build with Maven
        run: mvn install "-DskipMunitBoolean=true"

      - name: Deploy with Maven
        run:  mvn clean deploy "-DmuleDeploy"
                              "-Denv=Sandbox"
                              "-DskipMunitBoolean=true"
                              -s .maven/settings.xml
                              #"-Dap.client_id=20f8dfb151a449919157340fadcc8e41"
                              #"-Dap.client_secret=7c77704A6C544879acFcB2a17453C8be"
                              #"-Dap.analytics_base_uri=https://analytics-ingest.eu1.anypoint.mulesoft.com"
                              #"-Dap.base_uri=https://eu1.anypoint.mulesoft.com"
                              #"-Danypoint.platform.config.analytics.agent.enabled=true"                        
                              